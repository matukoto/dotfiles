#!/bin/bash

# ヘルプ
show_help() {
  echo "使用法: $0 --file <ファイル名> [--user <ユーザー名>] [--repo <リポジトリ名>]"
  echo "  -f, --file   検索したいファイル名 (必須)"
  echo "  -u, --user   検索対象ユーザー (任意)"
  echo "  -r, --repo   検索対象リポジトリ (任意: owner/repo または repo名)"
  echo "例1 (フォロー全員): $0 --file build.gradle"
  echo "例2 (特定ユーザー): $0 --file build.gradle --user torvalds"
  echo "例3 (特定リポジトリ/フォロー全員): $0 --file build.gradle --repo linux"
  echo "例4 (特定リポジトリ/特定ユーザー): $0 --file build.gradle --user torvalds --repo linux"
  echo "例5 (owner/repo指定): $0 --file build.gradle --repo torvalds/linux"
}

QUERY=""
TARGET_USER=""
TARGET_REPO=""

while [ "$#" -gt 0 ]; do
  case "$1" in
  -f | --file)
    shift
    QUERY="$1"
    ;;
  -u | --user)
    shift
    TARGET_USER="$1"
    ;;
  -r | --repo)
    shift
    TARGET_REPO="$1"
    ;;
  -h | --help)
    show_help
    exit 0
    ;;
  *)
    echo "エラー: 不明なオプションです: $1" >&2
    show_help
    exit 1
    ;;
  esac
  shift
done

if [ -z "$QUERY" ]; then
  echo "エラー: 検索したいファイル名を指定してください。" >&2
  show_help
  exit 1
fi

# code_search (上限10) の残り回数をチェックする関数
check_limit() {
  gh api rate_limit --method GET -H "Cache-Control: no-cache" --jq ".resources.code_search.remaining"
}

# 検索対象ユーザーを取得する関数
get_users() {
  if [ -n "$TARGET_USER" ]; then
    echo "--- Mode: Single User (@$TARGET_USER) ---" >&2
    echo "$TARGET_USER"
  else
    echo "--- Mode: All Following Users ---" >&2
    gh api user/following --paginate -q '.[].login'
  fi
}

build_query() {
  local user="$1"
  local base_query="filename:$QUERY"
  if [ -n "$TARGET_REPO" ]; then
    if [[ "$TARGET_REPO" == */* ]]; then
      base_query="$base_query+repo:$TARGET_REPO"
    else
      base_query="$base_query+repo:$user/$TARGET_REPO"
    fi
  fi
  echo "$base_query"
}

echo "--- Start Searching for '$QUERY' (Strict Mode: Limit 10/min) ---"

# メインループ
get_users | while read user; do

  # 残り回数チェック
  REMAINING=$(check_limit)

  # APIエラー等で空の場合は0扱いにする
  if [ -z "$REMAINING" ]; then REMAINING=0; fi

  # 残りが 2回以下なら、回復するまで長めに待機 (念の為70秒)
  if [ "$REMAINING" -le 2 ]; then
    echo "⚠️  Rate limit low ($REMAINING/10). Waiting 70 seconds..." >&2
    sleep 10
    REMAINING=$(check_limit)
  fi

  echo "Checking @$user... (Remaining: $REMAINING)" >&2

  # 検索実行
  gh api "search/code?q=$(build_query "$user")+user:$user" --paginate \
    -q '.items[] | "\(.repository.full_name): \(.path)"'

  # 【重要】制限が10回/分なので、少なくとも6秒以上空ける必要がある。
  # ギリギリを攻めるなら sleep 6 ですが、安全を見るなら sleep 7-8 推奨です。
  sleep 6
done
